package com.jctx.chat.service;

import javax.annotation.Resource;

import org.json.JSONObject;
import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;
import org.springframework.stereotype.Service;
import org.springframework.web.socket.WebSocketSession;

import com.jctx.chat.module.OnlineBean;
import com.jctx.chat.module.OnlineUserEntity;
import com.jctx.chat.module.OnlineUsersManager;

@Service("jedisService")
public class RedisServiceImp implements RedisService {
	
	
	@Resource
	OnlineUsersManager onlineUserManager;
	

	@Resource
	JedisConnectionFactory jedisFactory;

	@Override
	public void online(OnlineBean bean, WebSocketSession session) {
		try{
		
		OnlineUserEntity entity = new OnlineUserEntity(jedisFactory, bean, session);
		
		onlineUserManager.OnlineUser(bean.getSelf(), entity);
		
		}catch(Exception e){
			e.printStackTrace();
		}		
	}
	
	
	@Override
	public void handleTextMessage(String fromUid, String payload) {
		
		JSONObject message = new JSONObject(payload);
		
		String targetUid = message.getString("to");
		
		onlineUserManager.sendMessageToTarget(fromUid, targetUid, payload);
	}

	@Override
	public void onffline(String sessionId) {
		try{
			onlineUserManager.OfflineUser(sessionId);
		}catch(Exception e){
			e.printStackTrace();
		}
	}


	@Override
	public void keepalive(String sessionId) {
		onlineUserManager.keepalive(sessionId);		
	}
	
}
