package com.jctx.chat.service;

import java.sql.SQLException;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;

import com.jctx.chat.Utils.ChatException;
import com.jctx.chat.dao.FriendsApplyDao;
import com.jctx.chat.dao.FriendsRelationDao;
import com.jctx.chat.module.ChatUserBean;
import com.mysql.jdbc.exceptions.MySQLIntegrityConstraintViolationException;

@Service
public class FriendsService {

	@Resource FriendsApplyDao friendsApplyDao;
	
	@Resource FriendsRelationDao friendsRelationDao;
	
	public void applyAsFriends(ChatUserBean applicant, int targetUid) throws ChatException {
		
		try { 
			
			friendsApplyDao.applyFriends(applicant, targetUid);
			
			friendsRelationDao.recordThisApply(applicant, targetUid);
			
		}catch (SQLException ex) {
			if (ex  instanceof MySQLIntegrityConstraintViolationException)
				throw new ChatException("重复的申请");
		}
		
	}
	
	
	public void approvedAsFriends(ChatUserBean bean, int applicantUid) throws ChatException{
		
		int affected_row = friendsApplyDao.gotApproved(bean, applicantUid);
		if (1 != affected_row)
			throw new ChatException("更新申请状态失败");
		
		affected_row = friendsRelationDao.approveIt(bean, applicantUid);
		if (1 != affected_row)
			throw new ChatException("添加好友失败");
		
		affected_row = friendsRelationDao.addToMyRelation(bean, applicantUid);
		
		if (1 != affected_row)
			throw new ChatException("添加好友失败");
	} 
}
