package com.jctx.chat.module;

import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.connection.jedis.JedisConnection;
import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;

import redis.clients.jedis.Jedis;

public class MessageWriterPipe  implements Runnable{
	 
	JedisConnectionFactory jedisFactory;
	
	RedisConnection  pubconn;
	Jedis publisher;

	private OnlineBean bean;
	
	public MessageWriterPipe(JedisConnectionFactory jedisFactory, OnlineBean bean){
		
		this.jedisFactory = jedisFactory;
		
		pubconn =  jedisFactory.getConnection();
		
		publisher = ((JedisConnection)pubconn).getNativeConnection();
		
		this.bean = bean;
	}

	public void close() {
		pubconn.close(); 
	}

	public void pushlishToTarget(String targetUid, String payload) {
		
		boolean offline = publisher.publish(targetUid, payload) == 0;
		
		if (offline){
			this.publisher.rpush(targetUid, payload);
			this.pushNotification();
		}
	}

	private void pushNotification() {
		this.bean.getDevice();
	}

	@Override
	public void run() {
	}
}
